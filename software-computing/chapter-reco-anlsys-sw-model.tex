%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Where we describe the data analysis model for the experiment as it
% maps into the different phases of offline computing.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{DUNE Reconstruction and Analysis Software Model } \fixme{10 pages}
% \section{Analysis Algorithms and Event Processing Framework} \fixme{10 pages}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% beam simulation. Schellman

\section{Neutrino Flux Generation}

Neutrino flux calculations are now used to optimize and validate the LBNF beamline design the beamlines.  However, the same codes will likely play a very important role in the results from the full LBNF/DUNE long-baseline neutrino oscillation program over several decades.  As a result a continued program of validation and improvement of these codes will be necessary.

\subsection{Beamline simulation}

Current flux studies use a gaussian beam spot.  Full long term analysis will require integration of the proton beamline simulation into the neutrino flux calculations. 

\subsection{Target Modeling and Simulation}

Simulation and optimization of the LBNF beamlines have been performed and document by the Beam Optimization Task Force in 2017\cite{fields_doc_2901}. 
The LBNF neutrino beam simulation, G4LBNF\cite{g4lbnf}, uses a detailed 
model of the LBNF targets and focusing systems constructed within the GEANT4 framework. A beam of protons hits the target,
resulting in a cascade of physics processes including  particle production, propagation,
absorption and decay through material and the magnetic fields generated by the focusing horns. Different choices of  hadronic interaction models can lead to up to 40\% model uncertainties in the absolute flux.  The ppfx framework \cite{Aliaga} developed for the NuMI beamline allows incorporation of data from multiple  hadro-production experiments,  such as NA49, and NA61, in addition to the default GEANT4 models,  with the ability to add new information as it becomes available. The G4LBNF simulation continues to evolve as realistic designs for the LBNF target region are iterated.

The neutrinos produced by decays in the simulation are projected towards
the near and far detector for flux estimation. Substantial computational efficiencies are achieved in near-far flux studies by using each hadron that decays to neutrinos to calculate the relative acceptances of the near and far detectors analytically instead of tracing the neutrino trajectories directly\cite{Szleper:2001nj}.


\subsubsection{Typical size and time requirements for flux studies}
G4LBNE is a standalone GEANT4/root based product which operates outside the LarSoft and Art frameworks. 
A typical flux study involves 
2000 grid jobs taking around 2 CPU-hrs on FNAL grid nodes and producing 50 MB of output each.  Each job corresponds to 100,000 Protons on target.    


\subsection{Radiation and cooling design}
\subsubsection{MARS} % from the beamline CDR

An essential aspect of beam design work is numerical simulation of the primary and secondary neutrino beams. The MARS Monte Carlo  simulations provide input to detailed engineering calculations for beam heating effects for all components in or near the beams. The same software package gives radiological estimates for prompt and residual doses that dictate the amount of shielding needed along and tranverse to the beamline. At Fermilab, the MARS code \cite{abs_1} is used for all these estimates, with a sufficiently detailed model of the entire beam system.  

The MARS code itself is proprietary %check this
which leads to some restrictions on the computing model for running and distributing that code. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Simulation of Physics Processes}
\subsection{Neutrino Interaction Generation}
\subsection{Cosmic Ray Flux Simulation}
\subsection{Proton Decay Modeling}
\subsection{Noise Modeling and Noise Overlays}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Detector Simulation}
\subsection{Detector Response Modeling}
\subsection{Electronics and Digitization Modeling}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Calibration of detector responses}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Event Reconstruction Chain}
\subsection{Digital signal processing systems}
%\section{Signal processing./zero suppression/templates/FFT}

The raw digits from the Far Detector DAQ are uncompressed and arranged in a tick-major order: neighboring
time samples for the same channel are in neighboring memory locations.  Mitigation of ADC issues, such as
stuck bits is done at this stage via linear interpolation of neighboring time samples.  Correlated noise
is subtracted off by computing the median of channel responses within a front-end motherboard within a wire plane,
protecting potential signal pulses from being suppressed by neighboring signal pulses via a threshold identification
of signal.  The pedestal is then subtracted, which aids in raw digit event displays.
Noise filtering and the electronics and wire response functions are handled in a single step.
An FFT is performed on the raw ADC values after the mitigation described above, the spectrum is multiplied by
a kernel function including the filter and the multiplicative inverse of the spectrum of the field response and
electronics response, and then an inverse FFT translates the result back into the time domain.  The filtered,
deconvolved signal is stored as floating-point numbers as functions of the time sample with the same time sampling
as the initial ADC.  In the case of zero-suppressed data or Monte Carlo, regions of interest are defined in the
filtered, deconvoluted waveforms for storage and CPU efficiency.

A two-dimensional deconvolution~\cite{wirecell} has also been developed, which takes advantage of signals
induced on neighboring wires, as well as the time structure of the measured waveform on a wire to estimate the
undistorted arrival-time distribution of charge on the wire.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Liquid Argon Software Suites}

\subsection{Hit Finding}

Several algorithms have been developed to find hits, either in the raw waveforms which can be applied at the
trigger level, or on the filtered, deconvoluted waveforms.  The hit-finder used for most offline work fits
Gaussian functions to the waveforms.   

\subsection{Disambiguation}

In the case of induction-plane hits, a choice must be made of which
wire segment a hit belongs to, as the wrapped wires have up to three wire segments.  This choice is made by
matching hits in one induction plane with hits in the other two planes in time, and finding the most consistent
solution.  Hits that cannot be unambiguosly assigned wire segments in this manner (for example, one hit in one
view can correspond to many hits in another view, and the time of the large hit may be an average that doesn't
correspond closely to all of the hits in the other view), then the ambiguity choice is extrapolated from nearby
hits.

\subsection{Clustering Algorithms}

Clustering of hits can be done in 2D (one plane at a time) or in 3D.

\subsection{Pattern Recognition}
\subsection{Particle Tracking}
\subsection{Vertexing and Interaction Point Determination}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Object classification}
\subsection{Cluster classification}
\subsection{Track classification}
\subsection{Event classification}
\subsection{Interaction classification}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Data reduction and filtering}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Analysis Sets and Spectra}
\subsection{Normalization Tools}
\subsection{Fitters and Optimizer Interfaces}
\subsection{Monkeys trained to write Phys. Rev. Let. Articles\\ replace with ML by 2020}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Event Display}  %  add for version 2
